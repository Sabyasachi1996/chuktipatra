//user login
$(document).on("click", ".btn-login", function () {
    var error = false;
    var mobile_num  =   getValById("mobile_num");
    var random      =   $('meta[name="random-key"]').attr("content");

    hideError("mobile_num");

    if (mobile_num == "" || mobile_num.length < 10 || !validateMobile(mobile_num)) {
        error = true;
        showError("mobile_num", "Please enter valid mobile number");
    }

    if (!error) {
        var params = { mobile_num: encryptByAES(mobile_num, random) , random: random};
        $.ajax({
            url: BASE_URL + "user-authenticate",
            type: "post",
            data: params,
            dataType: "json",
            headers: {
                "X-CSRF-TOKEN": $('meta[name="csrf-token"]').attr("content"),
            },
            cache: false,
            beforeSend: function () {
                $(".btn-login").attr("disabled", true);
            },
            success: function (response) {
                if (response.error) {
                    $(".btn-login").attr("disabled", false);
                    showSnacBar(response.message, "error");
                } else {
                    $('#login_request').removeClass('show').addClass('hide');
                    $('#otp_request').removeClass('hide').addClass('show');
                    showSnacBar(response.message, "success");
                }
            },
        }); 
    }
});        

//aadhaar verify login otp
$(document).on("click", ".btn-verify-login-otp", function () {
    var error = false;
    var login_otp_num   =   getValById("login_otp_num");
    var random          =   $('meta[name="random-key"]').attr("content");

    hideError("login_otp_num");

    if (login_otp_num == "" || login_otp_num.length < 6) {
        error = true;
        showError("login_otp_num", "Please enter valid OTP");
    }

    if (!error) {
        var params = { otp_num: login_otp_num };
        $.ajax({
            url: BASE_URL + "validate-login-otp",
            type: "post",
            data: params,
            dataType: "json",
            headers: {
                "X-CSRF-TOKEN": $('meta[name="csrf-token"]').attr("content"),
            },
            cache: false,
            beforeSend: function () {
                $(".btn-verify-login-otp").attr("disabled", true);
            },
            success: function (response) {
                if (response.error) {
                    $('#login_request').removeClass('show').addClass('hide');
                    $('#otp_request').removeClass('hide').addClass('show');

                    $(".btn-verify-login-otp").attr("disabled", false);
                    showSnacBar(response.message, "error");
                } else {
                    showSnacBar(response.message, "success");
                    window.setTimeout(function () {
                        location.href = BASE_URL + "dashboard";
                    }, 5000);
                    
                }
            },
        });
    }
});

//aadhaar get otp for sign up
$(document).on("click", ".btn-get-aadhaar-otp", function () {
    var error = false;
    var aadhaar_num =   getValById("aadhaar_num");
    var random      =   $('meta[name="random-key"]').attr("content");

    hideError("aadhaar_num");

    if (aadhaar_num == "" || aadhaar_num.length < 12) {
        error = true;
        showError("aadhaar_num", "Please enter valid Aadhaar number");
    }

    if (!error) {
        var params = { aadhaar_num: encryptByAES(aadhaar_num, random) , random: random};
        $.ajax({
            url: BASE_URL + "generate-aadhaar-otp",
            type: "post",
            data: params,
            dataType: "json",
            headers: {
                "X-CSRF-TOKEN": $('meta[name="csrf-token"]').attr("content"),
            },
            cache: false,
            beforeSend: function () {
                $(".btn-get-aadhaar-otp").attr("disabled", true);
            },
            success: function (response) {
                if (response.error) {
                    $(".btn-get-aadhaar-otp").attr("disabled", false);
                    showSnacBar(response.message, "error");
                } else {
                    $('#aadhaar_request').removeClass('show').addClass('hide');
                    $('#otp_request').removeClass('hide').addClass('show');
                    $('#profile_request').removeClass('show').addClass('hide');

                    showSnacBar(response.message, "success");
                }
            },
        }); 
    }
});    

//aadhaar verify otp for sign up
$(document).on("click", ".btn-verify-aadhaar-otp", function () {
    var error = false;
    var otp_num     =   getValById("otp_num");
    var random      =   $('meta[name="random-key"]').attr("content");

    hideError("otp_num");

    if (otp_num == "" || otp_num.length < 6) {
        error = true;
        showError("otp_num", "Please enter valid OTP");
    }

    if (!error) {
        var params = { otp_num: otp_num };
        $.ajax({
            url: BASE_URL + "validate-aadhaar-otp",
            type: "post",
            data: params,
            dataType: "json",
            headers: {
                "X-CSRF-TOKEN": $('meta[name="csrf-token"]').attr("content"),
            },
            cache: false,
            beforeSend: function () {
                $(".btn-verify-aadhaar-otp").attr("disabled", true);
            },
            success: function (response) {
                if (response.error) {
                    $('#aadhaar_request').removeClass('show').addClass('hide');
                    $('#otp_request').removeClass('hide').addClass('show');
                    $('#profile_request').removeClass('show').addClass('hide');

                    $(".btn-verify-aadhaar-otp").attr("disabled", false);
                    showSnacBar(response.message, "error");
                } else {
                    $('#aadhaar_request').removeClass('show').addClass('hide');
                    $('#otp_request').removeClass('show').addClass('hide');
                    $('#profile_request').removeClass('hide').addClass('show');

                    $('#aadhaar_fullname').html(response.aadhaar_fullname);
                    $('#aadhaar_address').html(response.aadhaar_address);
                    
                    sessionStorage.setItem("aadhaar_verified", true);
                    showSnacBar(response.message, "success");
                }
            },
        });
    }
});

//save profile 
$(document).on("click", ".btn-profile-save", function () {
    var error = false;
    var profile_mobile     =   getValById("profile_mobile");

    hideError("profile_mobile");

    if (profile_mobile == "" || profile_mobile.length < 10) {
        error = true;
        showError("profile_mobile", "Please enter valid mobile number");
    }

    if (!error) {
        $(this).closest('form').submit();
    }
});   

$(document).on("click", ".btn_next_step2", function () {
    var applicant_type   =   $('input[name="lessor_lessee"]:checked').val();
    if(applicant_type !== undefined) {
        sessionStorage.setItem("eag_lessor_lessee", applicant_type);
        $(this).closest('form').submit();
    }
    else {
        alert("Please select the applicant type");
    }
});  

$("input[type='radio'][name='property_type']").click(function () {
    var property_type   =   $('input[name="property_type"]:checked').val();
    if(property_type !== undefined) {
        sessionStorage.setItem("eag_property_type", property_type);

        if(property_type == 'R') {
            $('#R').removeClass('hide').addClass('show');
            $('#C').removeClass('show').addClass('hide');
        }
        else {
            $('#R').removeClass('show').addClass('hide');
            $('#C').removeClass('hide').addClass('show');
        }
    }
    else {
        alert("Please select the property type");
    }
}); 

$(document).on("click", ".btn_next_step3", function () {
    var property_type   =   $('input[name="property_type"]:checked').val();
    if(property_type === undefined) {
        alert("Please select the property type");
    }
    else {
        var property_type   =   $('input[name="property_type"]:checked').val();
        var error = false;

        if(property_type == 'R') {

            var property_floor      =   getValById("property_floor");
            var property_room       =   getValById("property_room");
            var property_bed        =   getValById("property_bed");
            var property_bath       =   getValById("property_bath");
            var property_balcony    =   getValById("property_balcony");
            var property_area       =   getValById("property_area");
            var property_parking    =   $('input[name="property_parking"]:checked').val();
            var property_address    =   getValById("property_address");
            var property_city       =   getValById("property_city");
            var property_state      =   getValById("property_state");
            var property_pin        =   getValById("property_pin");

            hideError("property_floor");
            hideError("property_room");
            hideError("property_bed");
            hideError("property_bath");
            hideError("property_balcony");
            hideError("property_area");
            hideError("property_parking_area");
            hideError("property_address");
            hideError("property_city");
            hideError("property_state");
            hideError("property_pin");

            if (property_floor == "") {
                error = true;
                showError("property_floor", "Please select the floor");
            }

            if (property_room == "") {
                error = true;
                showError("property_room", "Please select the room details");
            }

            if (property_bed == "") {
                error = true;
                showError("property_bed", "Please select the number of bedroom");
            }

            if (property_area == "" || property_area < 0) {
                error = true;
                showError("property_area", "Please enter the aprox. area of the property");
            }

            if (property_parking === undefined) {
                error = true;
                showError("property_parking_area", "Please select parking");
            }

            if (property_address == "" || property_address.length < 10) {
                error = true;
                showError("property_address", "Please enter the address of the property");
            }

            if (property_city == "") {
                error = true;
                showError("property_city", "Please enter the city");
            }

            if (property_state == "") {
                error = true;
                showError("property_state", "Please enter the state");
            }

            if (property_pin == "" || property_pin.length < 6) {
                error = true;
                showError("property_pin", "Please enter the PIN code");
            }

            if(!error) {
                $(this).closest('form').submit();
            }

        }    
    }
}); 

$(document).on("click", ".btn_next_step4", function () {
    var error = false;
    var agreement_start     =   getValById("agreement_start");
    var rent_amount         =   getValById("rent_amount");
    var maintenance_amount  =   getValById("maintenance_amount");
    var security_amount     =   getValById("security_amount");
    
    hideError("agreement_start");
    hideError("rent_amount");
    hideError("maintenance_amount");
    hideError("security_amount");

    if (agreement_start == "") {
        error = true;
        showError("agreement_start", "Please select the agreement start date");
    }

    if (rent_amount == "" || rent_amount < 0) {
        error = true;
        showError("rent_amount", "Please enter the rent amount");
    }
    if (maintenance_amount == "" || maintenance_amount < 0) {
        error = true;
        showError("maintenance_amount", "Please enter the maintenance amount");
    }
    if (security_amount == "") {
        error = true;
        showError("security_amount", "Please enter the security amount");
    }

    if(!error) {
        $(this).closest('form').submit();
    }
});

$(document).on("click", ".show-cosigner-modal", function () {
    var ele = $(this);
    $('#agreement_id').val(ele.data('agreement'));
    $('#cosignerModalLabel').html("Send request to " + ele.data('title'));
    $('#cosignerModal').modal('show');
});  

$(document).on("click", ".show-witness-modal", function () {
    var ele = $(this);
    $('#agreement_id2').val(ele.data('agreement'));
    $('#witnessModal').modal('show');
});  

$(document).on("click", ".btn-coapp-request", function () {
    var error   =   false;
    var mobile_num  =   getValById("mobile_num");

    hideError("mobile_num");

    if (mobile_num == "" || mobile_num.length < 10) {
        error = true;
        showError("mobile_num", "Please enter valid mobile number");
    }

    if (!error) {
        $(this).closest('form').submit();
    }    
});   

$(document).on("click", ".btn-witness-request", function () {
    var error   =   false;
    var mobile_num1  =   getValById("mobile_num1");
    var mobile_num2  =   getValById("mobile_num2");

    hideError("mobile_num1");
    hideError("mobile_num2");

    if (mobile_num1 == "" || mobile_num1.length < 10) {
        error = true;
        showError("mobile_num1", "Please enter valid mobile number");
    }
    if (mobile_num2 == "" || mobile_num2.length < 10) {
        error = true;
        showError("mobile_num2", "Please enter valid mobile number");
    }

    if (!error) {
        $(this).closest('form').submit();
    }    
}); 

$(document).on("click", ".btn-verify-request", function () {
    var error   =   false;
    var agreement_id    =   getValById("agreement_id");
    var secret_code     =   getValById("secret_code");

    hideError("agreement_id");
    hideError("secret_code");

    if (agreement_id == "" || agreement_id.length < 13) {
        error = true;
        showError("agreement_id", "Please enter valid agreement number");
    }

    if (secret_code == "" || secret_code.length < 6) {
        error = true;
        showError("secret_code", "Please enter valid secret code");
    }

    if (!error) {
        $(this).closest('form').submit();
    }    
});    

$(document).on("click", ".show-aadhaar-modal", function () {
    var ele = $(this);
    $('#upload_agreement_id').val(ele.data('agreement'));
    $('#uploadModal').modal('show');
}); 

//get aadhaar otp for upload
$(document).on("click", ".btn-get-upload-aadhaar-otp", function () {
    var error           =   false;
    var aadhaar_num     =   getValById("aadhaar_num");
    var agreement_id    =   getValById("upload_agreement_id");
    var random          =   $('meta[name="random-key"]').attr("content");

    hideError("aadhaar_num");

    if (aadhaar_num == "" || aadhaar_num.length < 12) {
        error = true;
        showError("aadhaar_num", "Please enter valid Aadhaar number");
    }

    if (!error) {
        var params = { aadhaar_num: encryptByAES(aadhaar_num, random), random: random, agreement_num: agreement_id};
        $.ajax({
            url: BASE_URL + "generate-upload-aadhaar-otp",
            type: "post",
            data: params,
            dataType: "json",
            headers: {
                "X-CSRF-TOKEN": $('meta[name="csrf-token"]').attr("content"),
            },
            cache: false,
            beforeSend: function () {
                $(".btn-get-upload-aadhaar-otp").attr("disabled", true);
            },
            success: function (response) {
                if (response.error) {
                    $(".btn-get-upload-aadhaar-otp").attr("disabled", false);
                    showSnacBar(response.message, "error");
                } else {
                    $('#aadhaar_request').removeClass('show').addClass('hide');
                    $('#otp_request').removeClass('hide').addClass('show');

                    showSnacBar(response.message, "success");
                }
            },
        }); 
    }
}); 

//verify aadhaar otp for upload
$(document).on("click", ".btn-verify-upload-aadhaar-otp", function () {
    var error = false;
    var otp_num     =   getValById("otp_num");
    var random      =   $('meta[name="random-key"]').attr("content");

    hideError("otp_num");

    if (otp_num == "" || otp_num.length < 6) {
        error = true;
        showError("otp_num", "Please enter valid OTP");
    }

    if (!error) {
        var params = { otp_num: otp_num };
        $.ajax({
            url: BASE_URL + "validate-upload-aadhaar-otp",
            type: "post",
            data: params,
            dataType: "json",
            headers: {
                "X-CSRF-TOKEN": $('meta[name="csrf-token"]').attr("content"),
            },
            cache: false,
            beforeSend: function () {
                $(".btn-verify-upload-aadhaar-otp").attr("disabled", true);
            },
            success: function (response) {
                if (response.error) {
                    $('#aadhaar_request').removeClass('show').addClass('hide');
                    $('#otp_request').removeClass('hide').addClass('show');

                    $(".btn-verify-upload-aadhaar-otp").attr("disabled", false);
                    showSnacBar(response.message, "error");
                } else {
                    $('#aadhaar_request').removeClass('show').addClass('hide');
                    $('#otp_request').removeClass('show').addClass('hide');

                    showSnacBar(response.message, "success");

                    window.setTimeout(function () {
                        location.reload();
                    }, 3000);

                }
            },
        });
    }
});

//get udin otp to sign
$(document).on("click", ".btn-get-sign-doc-otp", function () {
    var error       =   false;
    var mobile_num  =   getValById("mobile_num");
    var udin_num    =   getValById("udin_num");
    var random      =   $('meta[name="random-key"]').attr("content");

    hideError("mobile_num");
    hideError("udin_num");

    if (mobile_num == "" || mobile_num.length < 10) {
        error = true;
        showError("mobile_num", "Please enter valid mobile number");
    }

    if (udin_num == "" || udin_num.length < 25) {
        error = true;
        showError("udin_num", "Please enter valid UDIN number");
    }

    if (!error) {
        var params = { udin_num: udin_num , mobile_num: mobile_num};
        $.ajax({
            url: BASE_URL + "generate-sign-document-otp",
            type: "post",
            data: params,
            dataType: "json",
            headers: {
                "X-CSRF-TOKEN": $('meta[name="csrf-token"]').attr("content"),
            },
            cache: false,
            beforeSend: function () {
                $(".btn-get-sign-doc-otp").attr("disabled", true);
            },
            success: function (response) {
                if (response.error) {
                    $(".btn-get-sign-doc-otp").attr("disabled", false);
                    showSnacBar(response.message, "error");
                } else {
                    $('#otp_request').removeClass('hide').addClass('show');
                    showSnacBar(response.message, "success");
                }
            },
        }); 
    }    
});  

//verify udin otp to sign
$(document).on("click", ".btn-verify-sign-doc-otp", function () {
    var error       =   false;
    var udin_num    =   getValById("udin_num");
    var mobile_num  =   getValById("mobile_num");
    var otp_num     =   getValById("otp_num");
    var random      =   $('meta[name="random-key"]').attr("content");

    hideError("udin_num");
    hideError("mobile_num");
    hideError("otp_num");

    if (udin_num == "" || udin_num.length < 25) {
        error = true;
        showError("udin_num", "Please enter valid UDIN number");
    }

    if (mobile_num == "" || mobile_num.length < 10) {
        error = true;
        showError("mobile_num", "Please enter valid mobile number");
    }

    if (otp_num == "" || otp_num.length < 6) {
        error = true;
        showError("otp_num", "Please enter valid OTP");
    }

    if (!error) {
        var params = { udin_num: udin_num, otp_num: otp_num, mobile_num: mobile_num};
        $.ajax({
            url: BASE_URL + "validate-sign-document-otp",
            type: "post",
            data: params,
            dataType: "json",
            headers: {
                "X-CSRF-TOKEN": $('meta[name="csrf-token"]').attr("content"),
            },
            cache: false,
            beforeSend: function () {
                $(".btn-verify-sign-doc-otp").attr("disabled", true);
            },
            success: function (response) {
                if (response.error) {
                    $(".btn-verify-sign-doc-otp").attr("disabled", false);
                    showSnacBar(response.message, "error");
                } else {
                    $("#modal_udin_num").val(udin_num);
                    $("#modal_phone_num").val(mobile_num);
                    var s = "<object data='" + response.file_url + "' type='application/pdf' ";
                    s += " width='100%' height='100%'></object>";

                    $("#pdf_content").html(s);

                    $("#owner_name").html(response.owner);
                    $("#owner_statement").html("<small>" + response.statement + "</small>");

                    
                    //show modal
                    $('#cosignPdfViewerModal').modal('show');
                }
            },
        }); 
    } 
});    

//get aadhaar otp to sign
$(document).on("click", ".btn-get-sign-aadhaar-otp", function () {
    var error = false;
    var aadhaar_num =   getValById("aadhaar_num");
    var phone_num   =   getValById("modal_phone_num");
    var udin_num    =   getValById("modal_udin_num");
    var random      =   $('meta[name="random-key"]').attr("content");

    hideError("aadhaar_num");

    if (aadhaar_num == "" || aadhaar_num.length < 12) {
        error = true;
        showError("aadhaar_num", "Please enter valid Aadhaar number");
    }

    if (!error) {
        var params = { udin_num: udin_num, phone_num: phone_num, aadhaar_num: encryptByAES(aadhaar_num, random), random: random};
        $.ajax({
            url: BASE_URL + "generate-sign-document-aadhaar-otp",
            type: "post",
            data: params,
            dataType: "json",
            headers: {
                "X-CSRF-TOKEN": $('meta[name="csrf-token"]').attr("content"),
            },
            cache: false,
            beforeSend: function () {
                $(".btn-get-sign-aadhaar-otp").attr("disabled", true);
            },
            success: function (response) {
                if (response.error) {
                    $(".btn-get-sign-aadhaar-otp").attr("disabled", false);
                    showSnacBar(response.message, "error");
                } else {
                    $('#aadhaar_request').removeClass('show').addClass('hide');
                    $('#aadhaar_otp_request').removeClass('hide').addClass('show');

                    $('#modal_trans_id').val(response.trans_id);
                    showSnacBar(response.message, "success");
                }
            },
        }); 
    }
});   

//verify aadhaar otp to sign
$(document).on("click", ".btn-verify-sign-aadhaar-otp", function () {
    var error = false;
    var otp_num     =   getValById("aadhaar_otp_num");
    var udin_num    =   getValById("modal_udin_num");
    var phone_num   =   getValById("modal_phone_num");
    var trans_id    =   getValById("modal_trans_id");
    var random      =   $('meta[name="random-key"]').attr("content");

    hideError("aadhaar_otp_num");

    if (otp_num == "" || otp_num.length < 6) {
        error = true;
        showError("aadhaar_otp_num", "Please enter valid OTP");
    }

    if (!error) {
        var params = { udin_num: udin_num, phone_num: phone_num, otp_num: otp_num, trans_id: trans_id };
        $.ajax({
            url: BASE_URL + "validate-sign-document-aadhaar-otp",
            type: "post",
            data: params,
            dataType: "json",
            headers: {
                "X-CSRF-TOKEN": $('meta[name="csrf-token"]').attr("content"),
            },
            cache: false,
            beforeSend: function () {
                $(".btn-verify-sign-aadhaar-otp").attr("disabled", true);
            },
            success: function (response) {
                if (response.error) {
                    $(".btn-verify-sign-aadhaar-otp").attr("disabled", false);
                    showSnacBar(response.message, "error");
                } else {

                    showSnacBar(response.message, "success");

                    window.setTimeout(function () {
                        location.href = BASE_URL + "dashboard";
                    }, 5000);

                }
            },
        });
    }
});  

//get final udin
$(document).on("click", ".btn-get-udin", function () {
    var udin_num = $(this).data("udin");
    var params = { udin_num: udin_num };
    $.ajax({
        url: BASE_URL + "get-final-udin",
        type: "post",
        data: params,
        dataType: "json",
        headers: {
            "X-CSRF-TOKEN": $('meta[name="csrf-token"]').attr("content"),
        },
        cache: false,
        beforeSend: function () {
        },
        success: function (response) {
            if (response.error) {
                showSnacBar(response.message, "error");
            } else {
                location.reload();
            }
        },
    });
});    

//download udin
$(document).on("click", ".btn-download-udin", function () {
    var udin_num = $(this).data("udin");

    var params = { udin_num: udin_num };
    $.ajax({
        url: BASE_URL + "download-udin-document",
        type: "post",
        data: params,
        dataType: "json",
        headers: {
            "X-CSRF-TOKEN": $('meta[name="csrf-token"]').attr("content"),
        },
        cache: false,
        beforeSend: function () {
        },
        success: function (response) {
            if (response.error) {
                showSnacBar(response.message, "error");
            } else {
                downloadPDF(response);
            }
        },
    });
});

//download PDF
function downloadPDF(response) {
    console.log(response);
    const downloadLink      =   document.createElement("a");
    const fileName          =   response.doc_name + ".pdf";
    downloadLink.href       =   response.doc_base64;
    downloadLink.download   =   fileName;
    downloadLink.click();
}
//ajax loader
$(document).ready(function(){
    $(document).ajaxStart(function(){
        $("#page_loader").show();
    });
    $(document).ajaxComplete(function(){
        $("#page_loader").hide();
    });
});